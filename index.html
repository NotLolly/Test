<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SKY TOD TRACKER</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Sarabun', Arial, sans-serif;
    background-color: #1e1e1e;
    color: white;
    margin: 0;
  }
  header {
    padding: 10px;
    text-align: center;
    font-weight: 700;
    font-size: 1.8em;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 10px;
    padding: 10px;
  }
  .card {
    background: #222;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 10px;
    transition: background-color 0.3s ease;
    position: relative;
  }
  .card h2 {
    margin: 0 0 6px 0;
  }
  .countdown {
    font-size: 1.3em;
    font-weight: 700;
  }
  .nextspawn {
    margin-top: 4px;
    font-size: 0.9em;
    color: #ccc;
  }
  .controls {
    margin-top: 10px;
    display: flex;
    gap: 6px;
  }
  button {
    background: none;
    border: 1px solid #555;
    color: white;
    padding: 6px 10px;
    cursor: pointer;
    border-radius: 5px;
    flex: 1;
    font-weight: 600;
    user-select: none;
  }
  button:hover {
    background: #333;
  }
  .icon-btn {
    flex: 0 0 40px;
    font-size: 1.3em;
    padding: 6px;
  }
  .reset-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: none;
    border: none;
    color: #bbb;
    font-size: 1.2em;
    cursor: pointer;
    user-select: none;
  }
  .reset-btn:hover {
    color: #fff;
  }
  /* Popup styles */
  #timePopupOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.75);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }
  #timePopup {
    background: #222;
    padding: 20px;
    border-radius: 10px;
    min-width: 260px;
    box-shadow: 0 0 10px #000;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #timePopup label {
    font-weight: 600;
  }
  #timeInputField {
    background: #333;
    border: 1px solid #555;
    color: white;
    font-size: 1.1em;
    padding: 6px 8px;
    border-radius: 5px;
    width: 100%;
    font-family: monospace;
  }
  #timePopupButtons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  #timePopupButtons button {
    flex: none;
    padding: 6px 14px;
  }
</style>
</head>
<body>

<header>SKY TOD TRACKER</header>

<audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<div class="grid" id="nmGrid"></div>

<!-- Time entry popup -->
<div id="timePopupOverlay">
  <div id="timePopup">
    <label for="timeInputField">Enter Time of Death (HH:MM:SS)</label>
    <input type="text" id="timeInputField" placeholder="e.g. 14:30:00" />
    <div id="timePopupButtons">
      <button id="cancelBtn">Cancel</button>
      <button id="setBtn">Set ToD</button>
    </div>
  </div>
</div>

<script type="module">
  // Your NM list and types
  const nms = [
    { name: "Despot", type: "cooldownOnly" },
    { name: "Steam Cleaner", type: "cooldownOnly" },
    { name: "Zipacna", type: "cooldownPlusLottery" },
    { name: "Mother Globe", type: "cooldownPlusLottery" },
    { name: "Faust", type: "cooldownPlusLottery" },
    { name: "Curtana", type: "cooldownPlusLottery" }
  ];

  let nmData = {};
  let editingNM = null;

  // Save/load to localStorage for persistence
  function saveData() {
    localStorage.setItem("nmTrackerData", JSON.stringify(nmData));
  }

  function loadData() {
    const stored = localStorage.getItem("nmTrackerData");
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        for (const key in parsed) {
          if (parsed[key].tod) {
            parsed[key].tod = new Date(parsed[key].tod);
          }
        }
        nmData = parsed;
      } catch {
        nmData = {};
      }
    }
  }

  // Calculate NM windows & spawns
  function calculateNMWindow(tod, type) {
    const results = {};
    if (type === "cooldownOnly") {
      const nextSpawn = new Date(tod.getTime() + 2 * 60 * 60 * 1000);
      results.possibleSpawns = [nextSpawn];
      results.windowStart = nextSpawn;
      results.windowEnd = nextSpawn;
    } else if (type === "cooldownPlusLottery") {
      const windowStart = new Date(tod.getTime() + 2 * 60 * 60 * 1000);
      const windowEnd = new Date(tod.getTime() + 3 * 60 * 60 * 1000);
      const spawns = [];
      for (let i = 0; i <= 6; i++) {
        spawns.push(new Date(windowStart.getTime() + i * 10 * 60 * 1000));
      }
      results.possibleSpawns = spawns;
      results.windowStart = windowStart;
      results.windowEnd = windowEnd;
    }
    return results;
  }

  // Update the countdown and card colors
  function updateTimers() {
    const now = new Date();
    nms.forEach(nm => {
      const data = nmData[nm.name];
      const cardElem = document.getElementById(`card-${nm.name}`);
      const cdElem = document.getElementById(`countdown-${nm.name}`);
      const nextElem = document.getElementById(`next-${nm.name}`);

      if (!data?.tod) {
        cdElem.textContent = "--";
        nextElem.textContent = "--";
        cardElem.style.backgroundColor = "#222";
        return;
      }

      const results = calculateNMWindow(data.tod, nm.type);
      const nextSpawn = results.possibleSpawns.find(spawn => spawn > now) || results.possibleSpawns[results.possibleSpawns.length - 1];
      const diff = Math.floor((nextSpawn - now) / 1000);

      // Color coding: before window = orange, in window = green, after window (and no update) = red
      if (now < results.windowStart) {
        cardElem.style.backgroundColor = "#b36000"; // orange before window
      } else if (now >= results.windowStart && now <= results.windowEnd) {
        cardElem.style.backgroundColor = "#007a00"; // green in window
        if (data.alerts && !data.windowAlerted) {
          document.getElementById("alertSound").play();
          data.windowAlerted = true;
          saveData();
        }
      } else {
        cardElem.style.backgroundColor = "#9a0000"; // red after window
      }

      if (diff > 0) {
        const h = Math.floor(diff / 3600);
        const m = Math.floor((diff % 3600) / 60);
        const s = diff % 60;
        cdElem.textContent = `${h}H ${m}M ${s}S`;
      } else {
        cdElem.textContent = "SPAWN CHECK!";
      }

      nextElem.textContent = `Next: ${nextSpawn.toLocaleTimeString()}`;
    });
  }

  // Create a card for each NM
  function createCard(nm) {
    const card = document.createElement("div");
    card.className = "card";
    card.id = `card-${nm.name}`;

    card.innerHTML = `
      <h2>${nm.name}</h2>
      <p class="countdown" id="countdown-${nm.name}">--</p>
      <p class="nextspawn" id="next-${nm.name}">--</p>
      <div class="controls">
        <button class="icon-btn" title="Edit ToD" aria-label="Edit ToD" onclick="openTimePopup('${nm.name}')">ðŸ•’</button>
        <button onclick="setToDNow('${nm.name}')" title="Set ToD to Now">Now</button>
        <button onclick="toggleSound('${nm.name}')" title="Toggle Alert">${nmData[nm.name]?.alerts ? "ðŸ”Š" : "ðŸ”‡"}</button>
      </div>
      <button class="reset-btn" title="Reset Timer" onclick="resetToD('${nm.name}')">âŸ²</button>
    `;
    return card;
  }

  // Open popup and prefill with current ToD or empty
  window.openTimePopup = function (nmName) {
    editingNM = nmName;
    const popup = document.getElementById("timePopupOverlay");
    const input = document.getElementById("timeInputField");
    const currentToD = nmData[nmName]?.tod;
    if (currentToD) {
      // Format as HH:MM:SS with zero padding
      const h = String(currentToD.getHours()).padStart(2, '0');
      const m = String(currentToD.getMinutes()).padStart(2, '0');
      const s = String(currentToD.getSeconds()).padStart(2, '0');
      input.value = `${h}:${m}:${s}`;
    } else {
      input.value = "";
    }
    popup.style.display = "flex";
    input.focus();
  };

  // Close popup
  function closeTimePopup() {
    document.getElementById("timePopupOverlay").style.display = "none";
    editingNM = null;
  }

  // Set ToD from popup input
  async function setToDFromPopup() {
    const input = document.getElementById("timeInputField");
    const val = input.value.trim();

    if (!editingNM) {
      closeTimePopup();
      return;
    }

    // Validate time format HH:MM or HH:MM:SS
    const timeMatch = val.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if (!timeMatch) {
      alert("Invalid time format. Use HH:MM or HH:MM:SS");
      return;
    }

    let [, hh, mm, ss] = timeMatch;
    hh = Number(hh);
    mm = Number(mm);
    ss = ss ? Number(ss) : 0;

    if (hh > 23 || mm > 59 || ss > 59) {
      alert("Invalid time values.");
      return;
    }

    // Build Date for today with entered time
    const now = new Date();
    const tod = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, ss);

    nmData[editingNM].tod = tod;
    nmData[editingNM].windowAlerted = false;
    saveData();
    closeTimePopup();
  }

  // Set ToD now shortcut
  window.setToDNow = function (nmName) {
    nmData[nmName].tod = new Date();
    nmData[nmName].windowAlerted = false;
    saveData();
  };

  // Toggle alert sound
  window.toggleSound = function (nmName) {
    nmData[nmName].alerts = !nmData[nmName].alerts;
    const card = document.getElementById(`card-${nmName}`);
    const btn = card.querySelector(".controls button:last-child");
    btn.textContent = nmData[nmName].alerts ? "ðŸ”Š" : "ðŸ”‡";
    saveData();
  };

  // Reset ToD for individual timer
  window.resetToD = function (nmName) {
    if (confirm(`Reset ToD for ${nmName}?`)) {
      nmData[nmName].tod = null;
      nmData[nmName].windowAlerted = false;
      saveData();
    }
  };

  // Hook popup buttons
  document.getElementById("cancelBtn").onclick = closeTimePopup;
  document.getElementById("setBtn").onclick = setToDFromPopup;

  // Initialize app
  function init() {
    loadData();

    const grid = document.getElementById("nmGrid");

    nms.forEach(nm => {
      if (!nmData[nm.name]) {
        nmData[nm.name] = { tod: null, alerts: false, windowAlerted: false };
      }
      grid.appendChild(createCard(nm));
    });

    setInterval(updateTimers, 1000);
  }

  init();
</script>

</body>
</html>
